name: Publish to GitHub Packages

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Dry run (skip actual publish)"
        required: false
        default: "false"

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME=${{ github.event.release.tag_name }}
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          fi
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION (tag: $TAG_NAME)"

      - name: Verify version matches package.json
        run: |
          PACKAGE_VERSION=$(node -p "require('./event-sourcing/typescript/package.json').version")
          RELEASE_VERSION="${{ steps.version.outputs.version }}"
          echo "Package version: $PACKAGE_VERSION"
          echo "Release version: $RELEASE_VERSION"
          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "‚ùå Version mismatch!"
            echo "package.json: $PACKAGE_VERSION"
            echo "Release tag: $RELEASE_VERSION"
            exit 1
          fi
          echo "‚úÖ Versions match!"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.20.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.x"
          cache: "pnpm"

      - name: Install Protocol Buffers compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: |
          cd event-sourcing/typescript
          pnpm run test

      - name: Run linter
        run: |
          cd event-sourcing/typescript
          pnpm run lint

      - name: Build package
        run: |
          cd event-sourcing/typescript
          pnpm run build

      - name: Verify build output
        run: |
          if [ ! -d "event-sourcing/typescript/dist" ]; then
            echo "‚ùå Build failed - dist directory not found"
            exit 1
          fi
          if [ ! -f "event-sourcing/typescript/dist/index.js" ]; then
            echo "‚ùå Build failed - index.js not found"
            exit 1
          fi
          echo "‚úÖ Build output verified"

  publish:
    name: Publish Package
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.20.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.x"
          registry-url: "https://npm.pkg.github.com"
          scope: "@event-sourcing-platform"
          cache: "pnpm"

      - name: Install Protocol Buffers compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package
        run: |
          cd event-sourcing/typescript
          pnpm run build

      - name: Publish to GitHub Packages
        if: ${{ github.event.inputs.dry-run != 'true' }}
        run: |
          cd event-sourcing/typescript
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > .npmrc
          pnpm publish --no-git-checks --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry run - Package ready
        if: ${{ github.event.inputs.dry-run == 'true' }}
        run: |
          echo "üöÄ Dry run mode - Package would be published"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo "Package: @event-sourcing-platform/typescript"

      - name: Create release notes
        if: ${{ github.event_name == 'release' && github.event.inputs.dry-run != 'true' }}
        run: |
          echo "## Published Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Package:** @event-sourcing-platform/typescript" >> $GITHUB_STEP_SUMMARY
          echo "üè∑Ô∏è **Version:** ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "üìù **Tag:** ${{ needs.validate.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "npm install @event-sourcing-platform/typescript@${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  verify-publication:
    name: Verify Publication
    runs-on: ubuntu-latest
    needs: [validate, publish]
    if: ${{ github.event.inputs.dry-run != 'true' }}

    steps:
      - name: Wait for package to be available
        run: sleep 30

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20.x"
          registry-url: "https://npm.pkg.github.com"
          scope: "@event-sourcing-platform"

      - name: Verify package is accessible
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > ~/.npmrc
          echo "@event-sourcing-platform:registry=https://npm.pkg.github.com" >> ~/.npmrc

          npm view @event-sourcing-platform/typescript@${{ needs.validate.outputs.version }} || {
            echo "‚ö†Ô∏è Package not immediately available (may take a few minutes)"
            exit 0
          }
          echo "‚úÖ Package successfully published and accessible"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
